##讨论课 - 复用云技术
####侧重于容器技术，讨论各种方案以及挑战
---
####一、Docker技术
Docker是一个为开发人员和系统管理员开发、迁移和运行应用程序的平台。应用程序通过Docker打包成Docker Image后，可以实现统一的方式来下载、启动、扩展、删除和迁移，这样方便了应用程序的部署和运维。本文将介绍Docker的主要组件、系统架构和工作原理，并实例演示Docker的一些简单操作。

#####Docker的主要组件
Docker引擎：开源的虚拟化容器技术平台。
Docker Hub：为用户提供共享和管理Docker容器的SaaS服务平台。

#####Docker的系统架构
Docker采用服务器/客户端模式。Docker客户端通过和Docker Daemon进行交互来新建、运行或者部署Docker容器。用户可以将Docker客户端和Docker Daemon安装在同一个系统上，也可以安装在不同的系统上。Docker客户端通过端口或者RESTfulAPI和Docker Daemon进行通信。



#####Docker daemon：
Docker daemon运行在一台主机上，终端用户不能直接与Daemon进行交互，只能通过Docker客户端与Docker Daemon进行通信。
Docker客户端：终端用户和Docker通信的主要端口。

----
####二、Vmware容器技术
 VMware最近宣布的两项容器解决方案，分别是vIC（整合了vSphere的容器技术vSphere Integrated Containers）和Photon平台，并与现有方案进行了对比。

第一个方案是vIC（整合了vSphere（国内领先的虚拟化平台）的容器技术vSphere Integrated Containers），这是VMware提出的一个进化的容器方案。根据VMware的介绍，vIC的理念是，容器本质上是"一个打包了依赖的、用于执行的、存在于私有命名空间private namespace的、资源受限的二进制可执行文件"，而容器宿主container host是“一个包含了必要的存储和网络架构的计算资源池，用于管理容器”。如果你接受这样一个前提的话，那么是什么构成容器和容器宿主并不重要，只要开发者们可以使用类似Docker APIs这样的标准容器APIs来访问这些资源就可以了。

vIC是从Bonneville项目发展而来，它将容器技术解构成了若干基本能力，然后通过组合VMware的ESXi、Photon OS和Instant Clone等技术来替换这些能力。这个解决方案可以将传统的vSphere架构和容器技术连接起来，使得VMware管理员使用熟悉的VMware工具（如vSphere）来管理这些特定类型的容器。



---

####三、Photon平台
如果说vIC是针对从传统虚拟机过渡到容器的客户的解决方案，那么Photon平台就是针对完全使用容器和Kubernetes、Mesos等容器管理工具的客户的解决方案。Photon平台被设计来提供可扩展性和高性能，就像“Google风格”的数据中心架构一样。在Photon平台中，为了完成这个目标，VMware将传统的ESXi虚拟层替换为一种新型的轻量级的“microvisor”，将容器作为应用发布的基本单元，并使用一种新型的、经过优化的容器管理工具，称为Photon控制器Photon Controller。

了解Photon平台的一个好方法就是与另一种容器架构比较，比如CoreOS的Tectonic平台。



LXC 中文名称就是 Linux 容器工具，容器可以提供轻量级的虚拟化，以便隔离进程和资源。使用 LXC 的优点就是不需要安装太多的软件包，使用过程也不会占用太多的资源， LXC 是在 Linux 平台上基于容器的虚拟化技术的未来标准，最初的 LXC 技术是由 IBM 研发的，目前已经进入 Linux 内核主线，这意味着 LXC 技术将是目前最有竞争力的轻量级虚拟容器技术，
LXC 项目由一个 Linux 内核补丁和一些用户空间（userspace） 工具组成。这些工具使用由补丁增加的内核新特性，提供一套简化的工具来维护容器。2.6.29 版本后的 Linux 内核版本已经包含该补丁提供的大部分功能。所以强烈建议使用最新的内核源代码。LXC 在资源管理方面依赖 Linux 内核的 cgroups (Control Groups) 系统，cgroups 系统是 Linux 内核提供的一个基于进程组的资源管理的框架，可以为特定的进程组限定可以使用的资源。它最初由 Google 的工程师提出，后来被整合进 Linux 内核。cgroups 也是 LXC 为实现虚拟化所使用的资源管理手段，可以说没有 cgroups 就没有 LXC。



大规模容器集群管理工具，从Borg到Kubernetes

在Docker 作为高级容器引擎快速发展的同时，Google也开始将自身在容器技术及集群方面的积累贡献出来。在Google内部，容器技术已经应用了很多年，Borg系统运行管理着成千上万的容器应用，在它的支持下，无论是谷歌搜索、Gmail还是谷歌地图，可以轻而易举地从庞大的数据中心中获取技术资源来支撑服务运行。

Borg是集群的管理器，在它的系统中，运行着众多集群，而每个集群可由成千上万的服务器联接组成，Borg每时每刻都在处理来自众多应用程序所提交的成百上千的Job, 对这些Job进行接收、调度、启动、停止、重启和监控。正如Borg论文中所说，Borg提供了3大好处: 1）隐藏资源管理和错误处理，用户仅需要关注应用的开发。 2) 服务高可用、高可靠。 3) 可将负载运行在由成千上万的机器联合而成的集群中。

作为Google的竞争技术优势，Borg理所当然的被视为商业秘密隐藏起来，但当Tiwtter的工程师精心打造出属于自己的Borg系统（Mesos）时， Google也审时度势地推出了来源于自身技术理论的新的开源工具。

2014年6月，谷歌云计算专家埃里克·布鲁尔（Eric Brewer）在旧金山的发布会为这款新的开源工具揭牌，它的名字Kubernetes在希腊语中意思是船长或领航员，这也恰好与它在容器集群管理中的作用吻合，即作为装载了集装箱（Container）的众多货船的指挥者，负担着全局调度和运行监控的职责。

虽然Google推出Kubernetes的目的之一是推广其周边的计算引擎（Google Compute Engine）和谷歌应用引擎（Google App Engine）。但Kubernetes的出现能让更多的互联网企业可以享受到连接众多计算机成为集群资源池的好处。

Kubernetes对计算资源进行了更高层次的抽象，通过将容器进行细致的组合，将最终的应用服务交给用户。Kubernetes在模型建立之初就考虑了容器跨机连接的要求，支持多种网络解决方案，同时在Service层次构建集群范围的SDN网络。其目的是将服务发现和负载均衡放置到容器可达的范围，这种透明的方式便利了各个服务间的通信，并为微服务架构的实践提供了平台基础。而在Pod层次上，作为Kubernetes可操作的最小对象，其特征更是对微服务架构的原生支持。

Kubernetes项目来源于Borg，可以说是集结了Borg设计思想的精华，并且吸收了Borg系统中的经验和教训。


在Borg项目中的Alloc，对应了Kubernetes的Pod, 它是在主机中预留的一块资源，用来让一个或一组Task运行在其中，而这同组的Task交互较为紧密，同时对外又以整体的方式运作。同样，Kubernetes中的Pod以巧妙的构成方式让多个容器实现资源共享，包括磁盘和网络，容器间的通信仅需要localhost即可完成，同时支持进程的状态检测和hook，通过细致的设置可以让容器间的组合在具有高性能的同时也具备很高的容错性，而对于上层调用者来说，放置着多个容器的Pod以整体的方式被创建启动运行或删除。

在监控调试方面，Borg提供了多层面的界面和调试工具，用户可以快速定位到相关Job的日志信息，并以此追踪到应用程序及底层服务的详细事件和错误信息。对此，Kubernetes沿用了众多Borg的运行方式，以Cadvisor来进行主机及实例监控，基于Elasticsearch/Kibana对日志进行收集等。

架构方面，Kubernetes的Master-Slave模式及多组件轻量级API交互的方式也是来自于Borg的灵感。Borg系统将资源调度基础界面等分解成多个进程来分别运行。Kubernetes更进一步地将Master设置为仅是处理请求和维护对象状态的核心，而调度和控制等由其他组件通过RESTAPI的方式和Master交互，其本身也是微服务架构的典型应用。

Kubernetes作为容器集群管理工具，于2015年7月22日迭代到 v 1.0并正式对外公布，这意味着这个开源容器编排系统可以正式在生产环境使用。与此同时，谷歌联合Linux基金会及其他合作伙伴共同成立了CNCF基金会( Cloud Native Computing Foundation)，并将Kuberentes 作为首个编入CNCF管理体系的开源项目，助力容器技术生态的发展进步。Kubernetes项目凝结了Google过去十年间在生产环境的经验和教训，从Borg的多任务Alloc资源块到Kubernetes的多副本Pod，从Borg的Cell集群管理，到Kubernetes设计理念中的联邦集群，在Docker等高级引擎带动容器技术兴起和大众化的同时，为容器集群管理提供独了到见解和新思路。


---------------------------------------------------------------------------------------------------------------------------------

####四、管理容器
管理容器可能需要用户付出大量的工作，首先需要考虑的一个问题就是选择一个合适的管理工具。对于基于容器技术的应用程序来说，主要有两种类型的管理工具：容器集群管理器和容器运行管理器。这些工具能够帮助用户管理容器的运行和规模，并监控容器的性能和安全性。

#####容器集群管理器

容器集群管理器，主要指Docker Swarm、CoreOS Tectonic 和谷歌Kubernetes，它整合了一个由多个服务器或节点组成的共享计算环境，其中的集成资源可用于支持工作负载和程序在集群内正常运行。用户可以在集群内使用程序来创建一个任务，然后使用这些任务以满足特定业务或IT的需求。这也涉及使用这些任务来创建一个工作。

如果需要退出这个功能，那么用户就应使用集群管理框架来管理一个或多个集群，而这个框架通常包括了一个资源管理器，它可用于跟踪诸如内存、CPU以及存储等资源。当任务运行需要资源时，必须通过资源管理器来获取所需的资源。用户还可以访问资源，这意味着他们可以管理集群的性能、响应时间以及其他。这就使得集群可拥有虚拟或物理上的可扩展性。

容器集群管理器的其他组件还包括一个任务管理器，它主要负责任务执行和状态的管理。集群管理器中还有一个调度管理组件，它可对组成工作的各个任务之间的依赖关系进行管理，并为各个节点分配任务。这个调度管理组件是集群管理器的一个核心组件；如果没有它，管理器将无法实现工作和任务的启动或停止。

#####容器运行管理器

对于管理容器的IT专业人士来说，他们可使用容器运行管理器这类工具来执行某些特定的任务，例如启动和停止基于容器的应用程序的运行、监控和管理资源、日志记录和根据预定义策略来执行某些自动化操作。

在去年十月被Docker收购的Tutum就是一个具有内置日志记录功能的容器管理工具，它能够允许用户访问他们容器的输出日志，并收集日志以供后期方便查看。Tutum还提供了可供用户检查容器状态的监控功能、一个可确保使用Tutum和Docker最新版功能的更新程序、以及一个API和一个控制面板。

#####容器管理的最佳实践

除了选择正确的工具以外，这里还有一些容器管理方面的通用技巧：

了解你的核心容器使用模式。有一些基于容器的应用程序是非常复杂的，它们需要大量的监控和管理。而另一些应用程序则相对更为简单，这些应用程序可能不需要扩展资源或者被严密监控。运行和维护容器管理工具的代价可能是较为昂贵的，所以应当只在你确定真的需要它们时才具体实施；你所拥有容器的数量和类型将具体决定你的需求。

不要过于关注工具。很多使用容器技术的组织过分关注可用工具，而不关心他们真正需要的功能。事实上，随着时间的推移，你所使用的容器管理工具也会不断更新变化。

在实践中不断学习。请始终关注你的容器、管理工具以及程序。持续不断地向自我提出更高要求，如何才能更好地或者更高效地使用这项技术。如有需要，及时更改或更新流程和工具。


---
####五、Mesos统一容器管理技术简介

Mesos现在支持的容器化技术用得比较多的主要有两个，一个是Mesos Containerizer技术，一个是Docker Containerizer技术。Mesos Containerizer主要是利用操作系统本身的一些特性例如cgroup,namespace等来实现对container的隔离;Docker Containerizer主要是通过Mesos Agent调用Docker API来容器进行管理。

但是现在对多种容器化技术进行管理存在一些问题：

　　如果在Mesos维护多种容器化技术，那么当为容器管理添加新功能时，需要对不同的容器化技术进行改动，将这些功能在不同的容器化技术中做实现。起码目前来说，需要在Mesos Containerizer和Docker Containerizer分别实现。

　　Docker Containerizer主要通过调用Docker API来实现对Docker容器的管理，但是Docker API给Mesos定制的机会就很有限了，尤其是对于容器运行时的定制，例如一些Entrypoint，Cmd，Env等等，所有的功能都需要依赖于Docker的API;而Mesos Containerizer可以让用户自己定制一些Mesos Isolator(隔离器)来实现自己对容器隔离的一些需求，例如对网络，存储等的一些需求，都可以通过Mesos Isolator自己去定制化。

　　Docker Containerizer需要依赖于Docker Daemon，如果Docker Daemon挂掉重启后，所有的Docker Containerizer不能恢复到以前的状态。Mesos需要保证即使用户的Docker Daemon挂掉了，用户还是可以通过Docker镜像创建Docker Container。

　　Docker在大规模的时候，不是很稳定，Mesos曾经发现一个bug，发现有些container不能被正常的停掉，后来经过调研发现，原因是服务器的Docker Contaier太多了，导致docker daemon处理不过来，没反应了。但是这种情况碰到的其实不是太多，因为现在国内大多数的客户其实规模不是很大。

　　现在容器的spec很多，包括Docker，AppC，OCI等等。未来也许这些不同的spec会统一，但是现在格式很多，用户用起来不是很方便。如果目前对不同的spec都做不同的容器化技术实现的话，未来会更难维护。

　　Docker社区不够开放，Docker现在能够提供为客户提供足够多的Offer，包括公有云形式的Docker Cloud，也有私有云模式的Docker Data Center，其它开源软件很难再从Docker获利。

　　基于以上原因，Mesos在0.28引入了一个新的功能，叫做统一的容器管理技术，主要是对当前的Mesos Containerizer做了一些改进，使Mesos Containerizer能够对不同spec的容器进行管理，包括Docker，AppC和OCI，到目前为止，已经完成了对Docker和AppC的支持，未来会完成对OCI的支持。至于现有的Docker Containerizer，在短期内应该还会被Mesos社区继续维护，但是应该不会再有大的改动。

